{% extends "skeleton.html" %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
<div class="container-fluid copy mt-5">
    <div class="container-fluid pt-2">
        <button type="button" class="btn btn-outline-dark" id="expand-button">Expand All Rows</button> <button type="button" class="btn btn-outline-dark" id="collapse-button">Collapse All Rows</button>
    </div>
    <table class="table table-bordered table-hover table-responsive mt-5 w-100" id="data">
        <caption style="caption-side: top; text-align: center;">Note: Use shift+click to sort by multiple columns</caption>
        <thead>
            <tr>
                <th rowspan="2"></th>
                <th rowspan="2" class="text-center">Case#</th>
                <th rowspan="2" class="text-center">Severity</th>
                <th colspan="3" class="text-center">Escalations</th>
                <th rowspan="2" class="text-center">Summary</th>
                <th rowspan="2" class="text-center">Product</th>
                <th rowspan="2" class="text-center">Case Group</th>
                <th rowspan="2" class="text-center">Account</th>
                <th rowspan="2" class="text-center">Status</th>
                <th rowspan="2" class="text-center">Assignee</th>
                <th rowspan="2" class="text-center">Jira</th>
                <th rowspan="2" class="text-center">Most Recent Comment</th>
                <th rowspan="2" class="text-center">Bugzillas</th>
                <th rowspan="2" class="text-center">Days Open</th>
                <th rowspan="2" class="text-center">Case Last Updated</th>
            </tr>
            <tr>
                <th class="text-center">On Prio-list?</th>
                <th class="text-center">On Watchlist?</th>
                <th class="text-center">Crit Sit?</th>
            </tr>
        </thead>
        <tbody class="list">
                {% for account in new_comments %}
                    {% for status in new_comments[account] %}
                        {% for card in new_comments[account][status]%}
                                <tr data-child-data='{{ new_comments[account][status][card] | tojson }}'>
                                    <td class="align-middle dt-control"></td>
                                    <td class="align-middle text-center"><a href=https://access.redhat.com/support/cases/#/case/{{new_comments[account][status][card]['case_number'] }} target="_blank">{{ new_comments[account][status][card]['case_number'] }}</a></td>
                                    <td class="align-middle text-center"><span class="badge severity {{ new_comments[account][status][card]['severity'] | lower() }}">{{ new_comments[account][status][card]['severity'] }}</span></td>
                                    {% if new_comments[account][status][card]['escalated'] %}
                                        <td class="align-middle text-center">Yes</td>
                                    {% else %}
                                        <td class="align-middle text-center">No</td>
                                    {% endif %}
                                    {% if new_comments[account][status][card]['watched'] %}
                                        <td class="align-middle text-center">Yes</td>
                                    {% else %}
                                        <td class="align-middle text-center">No</td>
                                    {% endif %}
                                    {% if new_comments[account][status][card]['crit_sit'] %}
                                        <td class="align-middle text-center">Yes</td>
                                    {% else %}
                                        <td class="align-middle text-center">No</td>
                                    {% endif %}
                                    <td class="align-middle">{{ new_comments[account][status][card]['summary'] }}</td>
                                    <td class="align-middle text-center">{{ new_comments[account][status][card]['product'] }}</td>
                                    <td class="align-middle text-center">{{ new_comments[account][status][card]['group_name'] }}</td>
                                    <td class="align-middle text-center">{{ new_comments[account][status][card]['account'] }}</td>
                                    <td class="align-middle text-center">{{ new_comments[account][status][card]['case_status'] }}</td>
                                    <td class="align-middle text-center">{{ new_comments[account][status][card]['assignee']['displayName'] }}</td>
                                    <td class="align-middle text-center"><a href=https://issues.redhat.com/browse/{{ card }} target="_blank">{{ card }}</a></td>
                                    <td class="align-middle"><span class="fw-bold fst-italic">{{ new_comments[account][status][card]['comments'][-1][1][:10] }}</span> - {{ new_comments[account][status][card]['comments'][-1][0] | safe }}</td>
                                    {% if new_comments[account][status][card]['bugzilla'] != "None" and new_comments[account][status][card]['bugzilla'] | length == 1  %}
                                        <td class="align-middle text-center"><a href={{ new_comments[account][status][card]['bugzilla'][0]['bugzillaLink'] }} target="_blank">{{ new_comments[account][status][card]['bugzilla'][0]['bugzillaNumber'] }}</a></td>
                                    {% elif new_comments[account][status][card]['bugzilla'] == "None"%}
                                        <td class="align-middle text-center">None</td>
                                    {% else %}
                                        <td class="align-middle text-center">Multiple - Expand for Details</td>
                                    {% endif %}
                                    <td class="align-middle text-center">{{ new_comments[account][status][card]['case_days_open'] }}</td>
                                    <td class="align-middle text-center">{{ new_comments[account][status][card]['case_updated_date'] }}</td>
                                </tr>
                        {% endfor %}        
                    {% endfor %}
                {% endfor %}
        </tbody>
    </table>
</div>
   <!-- Include jQuery + DataTables -->
   <script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='node_modules/jquery/dist/jquery.min.js') }}"></script>
   <script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='node_modules/datatables.net/js/jquery.dataTables.js') }}"></script>
   <script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='node_modules/datatables.net-bs5/js/dataTables.bootstrap5.min.js') }}"></script>
   <script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='js/plugins.js') }}"></script>
   <script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='node_modules/datatables.net-searchpanes/js/dataTables.searchPanes.min.js') }}"></script>
   <script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='node_modules/datatables.net-searchpanes-bs5/js/searchPanes.bootstrap5.min.js') }}"></script>
   <script type="text/javascript" charset="utf8" src="{{ url_for('static', filename='node_modules/datatables.net-select/js/dataTables.select.min.js') }}"></script>

   <script>
    // Insert Bugzilla Info and Comments into Child Rows
    function format(data) {
        let result = "<div class='card p-3'>"
        if (data.bugzilla != "None") {
            result += '<h3>Bugzillas</h3><table class="table table-bordered table-hover table-responsive w-100"><thead><tr><th>#</th><th>Summary</th><th>Target Release</th><th>Assignee</th><th>QA Contact</th><th>Last Updated</th><th>Status</th></tr></thead><tbody>';
            for (let bug = 0; bug < data.bugzilla.length; bug++) {
                result += '<tr><td><a href="' + data.bugzilla[bug].bugzillaLink + '" target="_blank">' + data.bugzilla[bug].bugzillaNumber + '</a></td><td>' + data.bugzilla[bug].summary  + '</td><td>' + data.bugzilla[bug].target_release[0] + '</td><td>' + data.bugzilla[bug].assignee + '</td><td>' + data.bugzilla[bug].qa_contact + '</td><td>' + data.bugzilla[bug].last_change_time + '</td><td>' + data.bugzilla[bug].status + '</td></tr>';
            }
            result += '</tbody></table>';
        }
        result += '<h3>Comments</h3><ul>';
        for (let comment = 0; comment < data.comments.length; comment++) {
            result += '<li class="text-break"><span class="fw-bold fst-italic">' + data.comments[comment][1].substring(0, 10) + '</span> - ' + data.comments[comment][0] + '</li>';
        }
        result += '</ul>';
    return result + "</div>";
    }

    // Sort Severities Correctly
    $.fn.dataTable.ext.type.detect.unshift(
        function ( d ) {
            let d_text;
            d = String(d);
            if (d.includes("Low") || d.includes("Normal") || d.includes("High") || d.includes("Urgent")) {
                d_text = jQuery(d).text();
            } else {
                d_text = d;
            }
            return d_text == 'Low' || d_text == 'Normal' || d_text == 'High' || d_text == 'Urgent' ?
                'severity-grade' :
                null;
        }
    );

    $.fn.dataTable.ext.type.order['severity-grade-pre'] = function ( d ) {
        let d_text = jQuery(d).text();
        switch ( d_text ) {
            case 'Low':    return 1;
            case 'Normal': return 2;
            case 'High':   return 3;
            case 'Urgent': return 4;
        }
        return 0;   
    };

    //Initialize DataTable
    $(document).ready(function () {
        let searchOptions = $.fn.dataTable.ext.deepLink([
            'search.search', 'order', 'displayStart'
        ]);
        let options = {
            "pageLength": 50,
            "scrollX": true,
            "scrollY": "75vh",
            "order": [[2, "desc"], [3, "desc"], [4, "desc"], [5, "desc"]],
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "searchPanes": {
                order: ['On Prio-list?', 'On Watchlist?', 'Crit Sit?', 'Escalated?', 'Account'],
                columns: [3, 4, 5, 9],
                initCollapsed: true,
                panes: [{
                    name: 'Escalated?',
                    header: 'Escalated?',
                    options: [{
                        label: 'Cases on Prio-list or Watchlist or Crit Sit',
                        value: function (rowData, rowIdx) {
                            return rowData[3] === 'Yes' || rowData[4] === 'Yes' || rowData[5] === 'Yes';
                        }
                    }]
                }]
            }
        };
        let table = $('#data').DataTable($.extend(options, searchOptions));
        table.searchPanes.container().prependTo(table.table().container());
        table.searchPanes.resizePanes();        
        // Add event listener for opening and closing details
        $('#data').on('click', 'td.dt-control', function () {
            let tr = $(this).closest('tr');
            let row = table.row(tr);

            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            } else {
                // Open this row
                row.child(format(tr.data('child-data'))).show();
                tr.addClass('shown');
            }
        });

        // Adapted from https://www.gyrocode.com/articles/jquery-datatables-how-to-expand-collapse-all-child-rows/
        $('#expand-button').on('click', function () {
            table.rows().every(function () {
                if (!this.child.isShown()) {
                    this.child(format($(this.node()).data('child-data'))).show();
                    $(this.node()).addClass('shown');
                }
            })
        });
        $('#collapse-button').on('click', function () {
            table.rows().every(function () {
                if (this.child.isShown()) {
                    this.child.hide();
                    $(this.node()).removeClass('shown');
                }
            })
        });
});
    </script>
{% endblock %}
